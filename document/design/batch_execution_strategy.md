# バッチ実行戦略設計書

## 🎯 推奨実行方式: 地域毎分割実行

### 📋 実行設計

#### 1. 地域グループ分割
```
Group 1: 東京都心部（地域1） - 実行時間: 30分
Group 2: 東京23区東部（地域2） - 実行時間: 45分  
Group 3: 東京23区南部（地域3） - 実行時間: 35分
Group 4: 東京23区西部（地域4） - 実行時間: 25分
Group 5: 東京23区北部（地域5） - 実行時間: 25分
Group 6: 東京都下（地域6） - 実行時間: 90分
Group 7: 横浜市（地域7） - 実行時間: 60分
Group 8: 川崎市（地域8） - 実行時間: 30分
Group 9: 相模原市（地域9） - 実行時間: 20分
Group 10: 神奈川県その他（地域10） - 実行時間: 40分
```

#### 2. 実行スケジュール（推奨）
```
02:00-02:30 | 地域1 (東京都心部)
02:30-03:15 | 地域2 (東京23区東部)  
03:15-03:50 | 地域3 (東京23区南部)
03:50-04:15 | 地域4 (東京23区西部)
04:15-04:40 | 地域5 (東京23区北部)
04:40-06:10 | 地域6 (東京都下) ※最大
06:10-07:10 | 地域7 (横浜市)
07:10-07:40 | 地域8 (川崎市)
07:40-08:00 | 地域9 (相模原市)
08:00-08:40 | 地域10 (神奈川県その他)
```

### 🛠️ 実装アプローチ

#### バッチスクリプト例
```bash
#!/bin/bash
# daily_scraping.sh

LOG_DIR="./logs/$(date +%Y%m%d)"
mkdir -p $LOG_DIR

# 各地域を順次実行
for region_id in {1..10}; do
    echo "$(date): 地域${region_id}の処理開始"
    
    if go run cmd/scraper/main.go -area=$region_id > "$LOG_DIR/region_${region_id}.log" 2>&1; then
        echo "$(date): 地域${region_id}の処理完了"
    else
        echo "$(date): 地域${region_id}の処理失敗" >&2
        # 失敗時は次の地域に継続（全体停止しない）
    fi
    
    # 地域間で30秒の間隔
    sleep 30
done

echo "$(date): 全地域の処理完了"
```

#### macOS cron設定
```bash
# crontab -e で設定
# 毎日午前2時に実行
0 2 * * * /Users/okubo/Go-project/realestate-scraper/scripts/daily_scraping.sh >> /Users/okubo/Go-project/realestate-scraper/logs/cron.log 2>&1
```

### ✅ 地域毎分割実行のメリット

1. **障害耐性**: 1地域の失敗が他に影響しない
2. **メモリ効率**: MacBook Air 16GBでも安全
3. **再実行容易**: 失敗した地域のみ再実行可能
4. **進捗把握**: どの地域まで完了したか明確
5. **SUUMO負荷軽減**: 地域間の間隔で負荷分散

## 🖥️ ローカル vs クラウド比較

### ローカル実行（M4 MacBook Air）

#### ✅ メリット
- **コスト**: 0円（電気代のみ）
- **データ所有**: 完全なプライバシー管理
- **カスタマイズ**: 自由な設定変更
- **レスポンス**: 高速なローカルアクセス

#### ⚠️ デメリット
- **可用性**: PC電源OFF時は実行不可
- **メンテナンス**: 自分でシステム管理が必要
- **バックアップ**: 手動でのデータ保護

#### 💰 年間コスト: 約5,000-8,000円
```
電気代: M4 MacBook Air 30W × 8時間/日 × 365日 × 30円/kWh ≈ 2,600円
外付けSSD: 15,000円（初期投資）
合計: 約17,600円（初年度）、2年目以降は電気代のみ
```

### クラウド実行

#### ✅ メリット
- **24/7稼働**: 安定した実行環境
- **自動スケーリング**: 負荷に応じたリソース調整
- **自動バックアップ**: データ保護の自動化
- **メンテナンスフリー**: インフラ管理不要

#### ⚠️ デメリット
- **継続コスト**: 月額料金が発生
- **データ転送**: アップロード/ダウンロード費用
- **設定複雑性**: クラウド知識が必要

### 💰 クラウドサービス費用試算

#### 1. AWS (最安構成)
```
EC2 t3.medium (2vCPU, 4GB RAM): $0.0416/時間
RDS PostgreSQL t3.micro: $0.017/時間  
EBS SSD 500GB: $0.10/GB/月
データ転送: $0.09/GB

月額費用:
- EC2: $0.0416 × 8時間 × 30日 = $9.98
- RDS: $0.017 × 24時間 × 30日 = $12.24  
- EBS: $0.10 × 500GB = $50.00
- データ転送: $0.09 × 50GB = $4.50
総額: 約$77/月 (約11,000円/月)
年額: 約132,000円
```

#### 2. Google Cloud Platform 
```
Compute Engine e2-standard-2: $0.067/時間
Cloud SQL PostgreSQL db-f1-micro: $0.0150/時間
SSD Persistent Disk 500GB: $0.17/GB/月

月額費用:
- Compute: $0.067 × 8時間 × 30日 = $16.08
- Cloud SQL: $0.015 × 24時間 × 30日 = $10.80
- Disk: $0.17 × 500GB = $85.00  
総額: 約$112/月 (約16,000円/月)
年額: 約192,000円
```

#### 3. Azure
```
B2s VM (2vCPU, 4GB): $0.0496/時間
Azure Database for PostgreSQL Basic: $0.017/時間
Premium SSD 512GB: $0.15/GB/月

月額費用:
- VM: $0.0496 × 8時間 × 30日 = $11.90
- Database: $0.017 × 24時間 × 30日 = $12.24
- Storage: $0.15 × 512GB = $76.80
総額: 約$101/月 (約14,000円/月)  
年額: 約168,000円
```

## 💡 コスト最適化戦略

### クラウド費用削減方法

#### 1. スポットインスタンス活用
```
AWS EC2 Spot Instance: 通常料金の20-30%
月額コスト: $77 → $25 (約3,500円/月)
年額: 約42,000円
```

#### 2. サーバーレス構成
```
AWS Lambda + RDS Aurora Serverless:
- Lambda: $0.20/100万リクエスト
- Aurora Serverless: $0.06/ACU時間
月額コスト: 約$30 (約4,200円/月)
年額: 約50,000円
```

#### 3. 自宅サーバー（Raspberry Pi）
```
初期費用: 
- Raspberry Pi 4 8GB: 12,000円
- SSD 1TB: 15,000円
- 電源・ケース等: 5,000円
合計: 32,000円

年間電気代: 約1,500円
トータル3年コスト: 約36,500円 (年換算12,000円)
```

## 🎯 推奨構成

### 個人利用なら: **ローカル実行（M4 MacBook Air）**

#### 理由
1. **圧倒的低コスト**: 年間8,000円 vs クラウド130,000円+
2. **十分な性能**: M4チップで高速処理
3. **データプライバシー**: 完全ローカル管理
4. **学習効果**: システム管理スキル向上

#### 運用改善案
```bash
# 自動復旧機能付きスクリプト
#!/bin/bash
MAX_RETRIES=3
for region_id in {1..10}; do
    for ((i=1; i<=MAX_RETRIES; i++)); do
        if go run cmd/scraper/main.go -area=$region_id; then
            break
        else
            echo "地域${region_id} 試行${i}回目失敗、30分後に再試行"
            sleep 1800  # 30分待機
        fi
    done
done
```

#### バックアップ戦略
```bash
# 日次バックアップスクリプト  
#!/bin/bash
BACKUP_DIR="/Volumes/ExternalSSD/backups/$(date +%Y%m%d)"
mkdir -p $BACKUP_DIR

# PostgreSQLダンプ
pg_dump realestate_db > $BACKUP_DIR/database.sql

# 画像ファイル
rsync -av ./data/images/ $BACKUP_DIR/images/

# 週次でクラウドバックアップ（オプション）
if [ $(date +%u) -eq 7 ]; then
    # Google Drive等にアップロード
    rclone sync $BACKUP_DIR GoogleDrive:backups/
fi
```

## 📊 最終推奨

### 🏆 **ローカル実行 + 外付けSSD + 定期バックアップ**

**コスト**: 年間8,000円
**安定性**: 高い（適切な運用により）
**メンテナンス**: 低い（月1回程度）
**データ安全性**: 高い（多重バックアップ）

この構成により、クラウドの1/15のコストで安定した運用が可能です。